{% extends "website/base.html" %}

{% load static %}

{% block meta_title %}{{ course.title }} - Online Quran Learning Course{% endblock %}
{% block meta_description %}{{ course.overview|truncatewords:25 }} Learn {{ course.title }} online with expert instructor {{ course.instructor.name }}. Join {{ course.enrollment_set.count }} students in this comprehensive Quran learning program.{% endblock %}
{% block meta_keywords %}{{ course.title }}, online quran course, {{ course.instructor.name }}, quran learning, islamic education, tajweed, arabic learning{% endblock %}

{% block og_type %}website{% endblock %}
{% block og_title %}{{ course.title }} - Online Quran Learning Course{% endblock %}
{% block og_description %}{{ course.overview|truncatewords:25 }} Learn {{ course.title }} online with expert instructor {{ course.instructor.name }}.{% endblock %}
{% block og_image %}{% if course.image %}{{ course.image.url }}{% else %}https://learnquranonlinee.com{% static 'assets/images/og-image.jpg' %}{% endif %}{% endblock %}

{% block twitter_title %}{{ course.title }} - Online Quran Learning Course{% endblock %}
{% block twitter_description %}{{ course.overview|truncatewords:25 }} Learn {{ course.title }} online with expert instructor {{ course.instructor.name }}.{% endblock %}
{% block twitter_image %}{% if course.image %}{{ course.image.url }}{% else %}https://learnquranonlinee.com{% static 'assets/images/twitter-image.jpg' %}{% endif %}{% endblock %}

{% block canonical_path %}/courses-details/{{ course.id }}/{% endblock %}

{% block schema_type %}Course{% endblock %}

{% block page_title %}{{ course.title }}{% endblock %}

{% block title %}
    Courses Details - {{ course.title }}
{% endblock %}

{% block content %}
    {% csrf_token %}
    
    <!-- Structured Data for Course -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Course",
        "name": "{{ course.title }}",
        "description": "{{ course.overview }}",
        "url": "https://learnquranonlinee.com/courses-details/{{ course.id }}/",
        "provider": {
            "@type": "Organization",
            "name": "Learn Quran Online",
            "url": "https://learnquranonlinee.com"
        },
        "instructor": {
            "@type": "Person",
            "name": "{{ course.instructor.name }}",
            "jobTitle": "{{ course.instructor.title }}",
            "image": "{% if course.instructor.image %}{{ course.instructor.image.url }}{% endif %}"
        },
        "courseMode": "online",
        "educationalLevel": "{{ course.level|default:'All Levels' }}",
        "inLanguage": ["English", "Arabic"],
        "coursePrerequisites": "{{ course.prerequisites|default:'No prerequisites required' }}",
        "numberOfCredits": "{{ course.lessons_count }}",
        
        "offers": {
            "@type": "Offer",
            "price": "{{ course.price }}",
            "priceCurrency": "USD",
            "availability": "https://schema.org/InStock"
        },
        "image": "{% if course.image %}{{ course.image.url }}{% endif %}",
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "{{ course.enrollment_set.count }}"
        }
    }
    </script>

    <section class="page-title"
             style="background-image:url('{% static "assets/images/background/page-title.jpg" %}'); margin-top:150px;">
        <div class="auto-container">
            <h1>{{ course.title }}</h1>
            <ul class="bread-crumb clearfix">
                <li><a href="{% url 'website:home' %}">Home</a></li>
                <li><a href="{% url 'website:courses' %}">Courses</a></li>
                <li>{{ course.title }}</li>
            </ul>
        </div>
    </section>

    <div class="sidebar-page-container style-two">
        <div class="auto-container">
            <div class="row clearfix">

                <!-- Content Side -->
                <div class="content-side col-lg-8 col-md-12 col-sm-12">
                    <div class="course-detail">
                        <div class="course-detail_inner">

                            <!-- Course Image -->
                            <div class="course-detail_image ratio ratio-16x9">
                                <img src="{{ course.image.url }}" alt="{{ course.title }} - Quran Learning Course"
                                     class="img-fluid w-50 h-50 object-fit-contain">
                            </div>

                            <!-- Course Content -->
                            <div class="course-detail_content">
                                <h2 class="course-detail_heading">{{ course.title }}</h2>

                                <div class="course-detail_info d-flex justify-content-between align-items-center flex-wrap">

                                    <!-- Author -->
                                    <div class="course-detail_author">
                                        <div class="course-detail_author-image">
                                            {% if course.instructor.image %}
                                                <img src="{{ course.instructor.image.url }}"
                                                     alt="{{ course.instructor.name }} - Quran Instructor">
                                            {% else %}
                                                <img src="{% static 'assets/images/default-avatar.png' %}"
                                                     alt="{{ course.instructor.name }} - Quran Instructor">
                                            {% endif %}
                                        </div>
                                        {{ course.instructor.name }}
                                        <span>{{ course.instructor.title }}</span>
                                    </div>

                                    <!-- List -->
                                    <ul class="course-detail_list">
                                        <li><span>{{ course.lessons_count }}</span> lessons</li>
                                        

                                        {# Count enrollments dynamically #}
                                        <li><span>{{ course.enrollment_set.count }}</span> enroll</li>
                                    </ul>

                                    <div class="course-detail_price">${{ course.price }} <span>Course Fee</span></div>
                                </div>

                                <h3 class="course-detail_subtitle">Course Overview</h3>
                                <p>{{ course.overview }}</p>

                                <!-- Product Info Tabs -->
                                <div class="course-detail-info-tabs">

                                    <div class="course-detail-tabs tabs-box">

                                        <!-- Tab Buttons -->
                                        <ul class="tab-btns tab-buttons clearfix">
                                            <li data-tab="#prod-curriculum" class="tab-btn active-btn">Curriculum</li>
                                            <li data-tab="#prod-instructor" class="tab-btn">Instructor</li>
                                            <li data-tab="#prod-review" class="tab-btn">Review</li>
                                            <li data-tab="#prod-faq" class="tab-btn">Faq</li>
                                        </ul>

                                        <!-- Tabs Content -->
                                        <div class="tabs-content">

                                            <!-- Curriculum Tab -->
                                            <div class="tab active-tab" id="prod-curriculum">
                                                <div class="content">
                                                    <h4 class="course-detail_subtitle">Course Structure</h4>
                                                    <p>{{ course.description }}</p>

                                                    <!-- Accordion Box for Curriculum Sections -->
                                                    <ul class="accordion-box">
                                                        {% for section in course.sections.all %}
                                                            <li class="accordion block">
                                                                <div class="acc-btn">
                                                                    <div class="icon-outer">
                                                                        <span class="icon icon-plus flaticon-padlock"></span>
                                                                        <span class="icon icon-minus flaticon-check-mark"></span>
                                                                    </div>
                                                                    {{ section.title }}
                                                                </div>
                                                                <div class="acc-content">
                                                                    <div class="content">
                                                                        <div class="text">{{ section.description }}</div>

                                                                        <!-- Lessons in this section -->
                                                                        <ul>
                                                                            {% for lesson in section.lessons.all %}
                                                                                <li>
                                                                                    {{ lesson.title }}
                                                                                    {% if lesson.is_preview_available %}
                                                                                        <i class="preview">preview</i>
                                                                                    {% endif %}
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        {% empty %}
                                                            <p>No curriculum sections available.</p>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>

                                            <!-- Instructor Tab -->
                                            <div class="tab" id="prod-instructor">
                                                <div class="content">

                                                    <div class="course-author_box">
                                                        <div class="course-author_box-inner">
                                                            <div class="course-author_box-image">
                                                                {% if course.instructor.image %}
                                                                    <img src="{{ course.instructor.image.url }}"
                                                                         alt="{{ course.instructor.name }} - Quran Instructor">
                                                                {% else %}
                                                                    <img src="{% static 'assets/images/default-avatar.png' %}"
                                                                         alt="{{ course.instructor.name }} - Quran Instructor">
                                                                {% endif %}
                                                            </div>
                                                            <h5 class="course-author_box-heading">{{ course.instructor.name }}<span>{{ course.instructor.title }}</span>
                                                            </h5>
                                                            <div class="course-author_box-text">{{ course.instructor.bio }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Review Tab -->
                                            <div class="tab" id="prod-review">
                                                <div class="content">
                                                    <p>No reviews available yet.</p>
                                                </div>
                                            </div>

                                            <!-- FAQ Tab -->
                                            <div class="tab" id="prod-faq">
                                                <div class="content">
                                                    <p>No FAQs available yet.</p>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar-side col-lg-4 col-md-12 col-sm-12">
                    <aside class="sidebar default-sidebar">

                        <div class="sidebar-widget course-widget">
                            <div class="widget-content">
                                <!-- Sidebar Title -->
                                <div class="sidebar-title">
                                    <h4>Course Features</h4>
                                </div>
                                <ul class="course-list">
                                    <li>Course Fee <span>${{ course.price }}</span></li>
                                    <li>Lessons <span>{{ course.lessons_count }}</span></li>
                                    
                                    <li>Students<span>{{ course.enrollment_set.count }}</span></li>
                                    <li><span>Trial Available</span> {{ course.is_trial_available|yesno:"Yes,No" }}</li>
                                    {% if course.is_trial_available %}
                                        <li><span>Trial Days</span> {{ course.trial_days }} days</li>
                                    {% endif %}
                                    <li>Level<span>Advanced</span></li>
                                </ul>
                                
                                <!-- Enrollment Status -->
                                {% if user.is_authenticated %}
                                    {% if user_enrollment %}
                                        <div class="enrollment-status">
                                            <div class="alert alert-success">
                                                <i class="fas fa-check-circle"></i>
                                                <strong>Enrolled!</strong>
                                                <p>You are enrolled in this course</p>
                                                <small>Enrolled on: {{ user_enrollment.enrolled_on|date:"M d, Y" }}</small>
                                            </div>
                                        </div>
                                    {% else %}
                                        <button class="theme-btn course-appy_btn enroll-btn" data-course-id="{{ course.id }}">
                                            <i class="fas fa-graduation-cap"></i> Enroll Now
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <a href="{% url 'account_login' %}" class="theme-btn course-appy_btn">
                                        <i class="fas fa-sign-in-alt"></i> Login to Enroll
                                    </a>
                                {% endif %}
                                
                                <!-- WhatsApp Contact - Only show for enrolled users -->
                                {% if user.is_authenticated and user_enrollment %}
                                    <div class="whatsapp-contact mt-3">
                                        <a href="https://wa.me/{{ app.whatsapp_number }}?text=Hi! I have a question about my enrolled course: {{ course.title }}. Can you help me?" 
                                           class="btn btn-success btn-block whatsapp-btn" target="_blank">
                                            <i class="fab fa-whatsapp"></i> Contact Course Supervisor
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                    </aside>
                </div>

            </div>
        </div>
    </div>

{% endblock content %}

{% block css %}
<style>
.enrollment-status {
    margin-bottom: 20px;
}

.enrollment-status .alert {
    border-radius: 8px;
    padding: 15px;
}

.enrollment-status i {
    margin-right: 8px;
}

.enroll-btn {
    width: 100%;
    margin-bottom: 15px;
}

.whatsapp-contact {
    margin-top: 20px;
}

.whatsapp-btn {
    background-color: #25d366;
    border-color: #25d366;
    width: 100%;
}

.whatsapp-btn:hover {
    background-color: #128c7e;
    border-color: #128c7e;
}

.whatsapp-btn i {
    margin-right: 8px;
}
</style>
{% endblock %}

{% block js_code %}
<script>
$(document).ready(function() {
    // Handle course enrollment
    $('.enroll-btn').click(function() {
        const courseId = $(this).data('course-id');
        const button = $(this);
        
        $.ajax({
            url: `/enroll-course/${courseId}/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Replace button with enrolled status
                    button.replaceWith(`
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>Enrolled!</strong>
                            <p>You are enrolled in this course</p>
                        </div>
                    `);
                    
                    // No alert shown on success
                } else if (response.status === 'already_enrolled') {
                    alert('You are already enrolled in this course!');
                }
            },
            error: function() {
                alert('An error occurred. Please try again.');
            }
        });
    });
});
</script>
{% endblock %}
